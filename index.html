<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Model Viewer - Professional Renders</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400..700&display=swap" rel="stylesheet">

    <!-- Modular Stylesheets -->
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/layout.css">
    <link rel="stylesheet" href="styles/controls.css">
    <link rel="stylesheet" href="styles/buttons.css">
    <link rel="stylesheet" href="styles/modal.css">
    <link rel="stylesheet" href="styles/utils.css">

    <!-- Dependencies for export functionality -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <!-- Three.js Library and Loaders (r162+ for environment rotation support) -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.162.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // Expose THREE and loaders globally
        window.THREE = THREE;
        window.GLTFLoader = GLTFLoader;
        window.FBXLoader = FBXLoader;
        window.RGBELoader = RGBELoader;
        window.OrbitControls = OrbitControls;

        console.log('✅ Three.js core libraries loaded');
    </script>

    <!-- Path Tracer Library (loaded separately due to complex dependencies) -->
    <script type="module">
        // Load path tracer with explicit dependency resolution
        async function loadPathTracer() {
            try {
                // Import three-mesh-bvh first
                const bvhModule = await import('https://cdn.jsdelivr.net/npm/three-mesh-bvh@0.7.8/+esm');
                console.log('✅ three-mesh-bvh loaded');

                // Then import three-gpu-pathtracer
                const pathtracerModule = await import('https://cdn.jsdelivr.net/npm/three-gpu-pathtracer@0.0.22/+esm');

                // Expose globally
                window.WebGLPathTracer = pathtracerModule.WebGLPathTracer;
                window.PhysicalCamera = pathtracerModule.PhysicalCamera;
                window.PathtracerModule = pathtracerModule;

                console.log('✅ Path tracer library loaded successfully');

                // Dispatch event so UI knows it's ready
                window.dispatchEvent(new Event('pathtracerReady'));
            } catch (err) {
                console.error('❌ Path tracer failed to load:', err);
                console.warn('Path tracing features will be disabled');
                console.warn('Error details:', err.message);
            }
        }

        // Load after a short delay to ensure THREE is fully initialized
        setTimeout(loadPathTracer, 100);
    </script>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-title">3D Model Viewer</div>
        <div class="header-credit">MADE BY STUDIO-VIDEO</div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Side Panel -->
        <div class="side-panel">
            <div class="panel-header">
                <h3>Controls</h3>
            </div>

            <!-- CANVAS SECTION -->
            <div class="controls-section section-with-divider">
                <h4>Canvas Size</h4>

                <div class="frame-control-row">
                    <label>Dimensions (px)</label>
                </div>
                <div class="size-inputs">
                    <input type="number" id="canvas-width" value="1080" min="100" max="7680">
                    <span style="color: var(--text-color-subtle);">×</span>
                    <input type="number" id="canvas-height" value="1350" min="100" max="4320">
                </div>

                <div class="preset-buttons">
                    <div class="preset-btn" data-size="800,600">HD</div>
                    <div class="preset-btn" data-size="1920,1080">FHD</div>
                    <div class="preset-btn active" data-size="1080,1350">Vertical</div>
                    <div class="preset-btn" data-size="1080,1080">1:1</div>
                    <div class="preset-btn" data-size="1080,1920">9:16</div>
                    <div class="preset-btn" data-size="3840,2160">4K</div>
                </div>
            </div>

            <!-- MODEL UPLOAD SECTION -->
            <div class="controls-section section-with-divider">
                <h4>Model Upload</h4>

                <div class="control-btn" id="model-upload-btn" style="width: 100%; text-align: center; position: relative;">
                    <span id="model-upload-text">Upload 3D Model</span>
                    <span class="remove-image" id="model-remove-btn" style="display: none;">&times;</span>
                </div>
                <input type="file" id="model-upload-input" accept=".glb,.gltf,.fbx" style="display: none;">

                <div style="font-size: 11px; color: var(--text-color-subtle); margin-top: 8px; text-align: center;">
                    Supports: GLB, GLTF, FBX
                </div>
            </div>

            <!-- SHADER PRESET SECTION -->
            <div class="controls-section section-with-divider">
                <h4>Material Shader</h4>

                <!-- Shader Preset -->
                <div class="frame-control-row">
                    <label for="shader-preset">Preset</label>
                </div>
                <select id="shader-preset">
                    <option value="custom">Custom (Original)</option>
                    <option value="metallic">Metallic</option>
                    <option value="plastic">Plastic</option>
                    <option value="glass">Glass</option>
                    <option value="matte">Matte</option>
                    <option value="glossy">Glossy</option>
                </select>
                <div style="font-size: 11px; color: var(--text-color-subtle); margin-top: 8px;">
                    Presets preserve textures and modify surface properties
                </div>
            </div>

            <!-- TRANSFORM CONTROLS SECTION -->
            <div class="controls-section section-with-divider">
                <h4>Transform</h4>

                <!-- Scale -->
                <div class="frame-control-row">
                    <label for="model-scale">Scale</label>
                    <span id="model-scale-value" style="color: var(--text-color-subtle);">1.0</span>
                </div>
                <input type="range" id="model-scale" min="0.1" max="5" step="0.1" value="1" class="slider">

                <!-- Position X -->
                <div class="frame-control-row" style="margin-top: 12px;">
                    <label for="model-pos-x">Position X</label>
                    <span id="model-pos-x-value" style="color: var(--text-color-subtle);">0.0</span>
                </div>
                <input type="range" id="model-pos-x" min="-5" max="5" step="0.1" value="0" class="slider">

                <!-- Position Y -->
                <div class="frame-control-row" style="margin-top: 12px;">
                    <label for="model-pos-y">Position Y</label>
                    <span id="model-pos-y-value" style="color: var(--text-color-subtle);">0.0</span>
                </div>
                <input type="range" id="model-pos-y" min="-5" max="5" step="0.1" value="0" class="slider">

                <!-- Rotation X -->
                <div class="frame-control-row" style="margin-top: 12px;">
                    <label for="model-rot-x">Rotation X</label>
                    <span id="model-rot-x-value" style="color: var(--text-color-subtle);">0°</span>
                </div>
                <input type="range" id="model-rot-x" min="0" max="360" step="1" value="0" class="slider">

                <!-- Rotation Y -->
                <div class="frame-control-row" style="margin-top: 12px;">
                    <label for="model-rot-y">Rotation Y</label>
                    <span id="model-rot-y-value" style="color: var(--text-color-subtle);">0°</span>
                </div>
                <input type="range" id="model-rot-y" min="0" max="360" step="1" value="0" class="slider">

                <!-- Rotation Z -->
                <div class="frame-control-row" style="margin-top: 12px;">
                    <label for="model-rot-z">Rotation Z</label>
                    <span id="model-rot-z-value" style="color: var(--text-color-subtle);">0°</span>
                </div>
                <input type="range" id="model-rot-z" min="0" max="360" step="1" value="0" class="slider">
            </div>

            <!-- HDRI LIGHTING SECTION -->
            <div class="controls-section section-with-divider">
                <h4>HDRI Lighting</h4>

                <!-- HDRI Preset -->
                <div class="frame-control-row">
                    <label for="hdri-preset">Environment (2K Quality)</label>
                </div>
                <select id="hdri-preset">
                    <option value="studio">Studio Loft Hall</option>
                    <option value="sunset">Venice Sunset</option>
                    <option value="outdoor">Outdoor Cloudy</option>
                    <option value="warehouse">Industrial Sunset</option>
                    <option value="night">Moonlit Golf</option>
                    <option value="autumn">Autumn Crossing</option>
                    <option value="urban">Urban Alley</option>
                </select>

                <!-- Show HDRI Background -->
                <div style="margin-top: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="hdri-show-bg" style="cursor: pointer;">
                        <span>Show HDRI Background</span>
                    </label>
                    <div style="font-size: 11px; color: var(--text-color-subtle); margin-top: 4px; margin-left: 24px;">
                        Display HDRI as background (lighting always active)
                    </div>
                </div>

                <!-- HDRI Intensity -->
                <div class="frame-control-row" style="margin-top: 16px;">
                    <label for="hdri-intensity">Intensity</label>
                    <span id="hdri-intensity-value" style="color: var(--text-color-subtle);">1.0</span>
                </div>
                <input type="range" id="hdri-intensity" min="0" max="3" step="0.1" value="1" class="slider">

                <!-- HDRI Rotation -->
                <div class="frame-control-row" style="margin-top: 12px;">
                    <label for="hdri-rotation">Rotation</label>
                    <span id="hdri-rotation-value" style="color: var(--text-color-subtle);">0°</span>
                </div>
                <input type="range" id="hdri-rotation" min="0" max="360" step="1" value="0" class="slider">

                <div style="border-top: 1px solid var(--border-color); margin: 16px 0;"></div>

                <!-- Sun Light -->
                <div style="margin-top: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="sun-enabled" checked style="cursor: pointer;">
                        <span>Enable Sun Light</span>
                    </label>
                    <div style="font-size: 11px; color: var(--text-color-subtle); margin-top: 4px; margin-left: 24px;">
                        User-controlled directional light with shadows
                    </div>
                </div>

                <!-- Sun Intensity -->
                <div class="frame-control-row" style="margin-top: 16px;">
                    <label for="sun-intensity">Intensity</label>
                    <span id="sun-intensity-value" style="color: var(--text-color-subtle);">2.0</span>
                </div>
                <input type="range" id="sun-intensity" min="0" max="10" step="0.1" value="2" class="slider">

                <!-- Sun Azimuth (Horizontal Rotation) -->
                <div class="frame-control-row" style="margin-top: 12px;">
                    <label for="sun-azimuth">Azimuth</label>
                    <span id="sun-azimuth-value" style="color: var(--text-color-subtle);">180°</span>
                </div>
                <input type="range" id="sun-azimuth" min="0" max="360" step="1" value="180" class="slider">

                <!-- Sun Elevation (Vertical Angle) -->
                <div class="frame-control-row" style="margin-top: 12px;">
                    <label for="sun-elevation">Elevation</label>
                    <span id="sun-elevation-value" style="color: var(--text-color-subtle);">45°</span>
                </div>
                <input type="range" id="sun-elevation" min="-90" max="90" step="1" value="45" class="slider">

                <!-- Sun Color -->
                <div class="frame-control-row" style="margin-top: 12px;">
                    <label for="sun-color">Color:</label>
                    <input type="color" id="sun-color" value="#ffffff" class="color-picker">
                </div>

                <!-- Shadow Softness -->
                <div class="frame-control-row" style="margin-top: 12px;">
                    <label for="shadow-softness">Shadow Softness</label>
                    <span id="shadow-softness-value" style="color: var(--text-color-subtle);">4</span>
                </div>
                <input type="range" id="shadow-softness" min="1" max="10" step="1" value="4" class="slider">

                <!-- Shadow Intensity -->
                <div class="frame-control-row" style="margin-top: 12px;">
                    <label for="shadow-intensity">Shadow Intensity</label>
                    <span id="shadow-intensity-value" style="color: var(--text-color-subtle);">0.5</span>
                </div>
                <input type="range" id="shadow-intensity" min="0" max="1" step="0.05" value="0.5" class="slider">

                <!-- Shadow Quality -->
                <div class="frame-control-row" style="margin-top: 16px;">
                    <label for="shadow-quality">Shadow Quality</label>
                </div>
                <select id="shadow-quality">
                    <option value="1024">Low (1024×1024)</option>
                    <option value="2048" selected>Medium (2048×2048)</option>
                    <option value="4096">High (4096×4096)</option>
                </select>
                <div style="font-size: 11px; color: var(--text-color-subtle); margin-top: 4px;">
                    Higher quality = sharper shadows, more GPU memory
                </div>
            </div>

            <!-- PATH TRACING SECTION -->
            <div class="controls-section section-with-divider">
                <h4>Path Tracing</h4>

                <!-- Enable Path Tracing -->
                <div style="margin-top: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="pathtracing-enabled" style="cursor: pointer;">
                        <span>Enable Path Tracing <span style="color: var(--text-color-subtle); font-size: 11px;">(Experimental)</span></span>
                    </label>
                    <div style="font-size: 11px; color: var(--text-color-subtle); margin-top: 4px; margin-left: 24px;">
                        Photorealistic rendering (progressive refinement)
                    </div>
                </div>

                <!-- Quality Preset -->
                <div class="frame-control-row" style="margin-top: 16px;">
                    <label for="pathtracing-quality">Quality</label>
                </div>
                <select id="pathtracing-quality">
                    <option value="fast">Fast (5 bounces, 50 samples)</option>
                    <option value="medium" selected>Medium (10 bounces, 200 samples)</option>
                    <option value="high">High (15 bounces, 1000 samples)</option>
                    <option value="ultra">Ultra (20 bounces, 5000 samples)</option>
                </select>

                <!-- Samples Counter -->
                <div id="pathtracing-stats" style="display: none; margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                    <div style="font-size: 12px; color: var(--text-color-subtle); margin-bottom: 4px;">
                        Rendering Progress
                    </div>
                    <div style="font-size: 14px; font-weight: 600; color: var(--primary-color);">
                        Samples: <span id="pathtracing-samples">0</span> / <span id="pathtracing-target">200</span>
                    </div>
                    <div style="margin-top: 8px;">
                        <div class="control-btn" id="pathtracing-reset-btn" style="width: 100%; text-align: center; font-size: 12px; padding: 6px;">
                            Reset Render
                        </div>
                    </div>
                </div>

                <!-- WebGL 2.0 Warning (hidden by default) -->
                <div id="pathtracing-warning" style="display: none; margin-top: 12px; padding: 8px; background: rgba(255, 100, 100, 0.1); border-left: 3px solid #ff6464; border-radius: 4px;">
                    <div style="font-size: 11px; color: #ff6464;">
                        ⚠️ Path tracing requires WebGL 2.0 support
                    </div>
                </div>
            </div>

            <!-- ANIMATION SECTION -->
            <div class="controls-section section-with-divider">
                <h4>Animation</h4>

                <!-- Camera Orbit Toggle -->
                <div style="margin-top: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="orbit-enabled" style="cursor: pointer;">
                        <span>Enable Camera Orbit</span>
                    </label>
                    <div style="font-size: 11px; color: var(--text-color-subtle); margin-top: 4px; margin-left: 24px;">
                        Manual camera control with mouse/touch (drag to rotate, scroll to zoom)
                    </div>
                </div>

                <!-- Turntable Toggle -->
                <div style="margin-top: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="turntable-enabled" style="cursor: pointer;">
                        <span>Enable Turntable</span>
                    </label>
                    <div style="font-size: 11px; color: var(--text-color-subtle); margin-top: 4px; margin-left: 24px;">
                        Model rotates on multiple axes (combine X/Y/Z for effects)
                    </div>
                </div>

                <!-- Turntable X-Axis Speed -->
                <div class="frame-control-row" style="margin-top: 16px;">
                    <label for="turntable-speed-x">X-Axis Speed</label>
                    <span id="turntable-speed-x-value" style="color: var(--text-color-subtle);">0.0</span>
                </div>
                <input type="range" id="turntable-speed-x" min="-2" max="2" step="0.1" value="0" class="slider">

                <!-- Turntable Y-Axis Speed -->
                <div class="frame-control-row" style="margin-top: 12px;">
                    <label for="turntable-speed-y">Y-Axis Speed</label>
                    <span id="turntable-speed-y-value" style="color: var(--text-color-subtle);">1.0</span>
                </div>
                <input type="range" id="turntable-speed-y" min="-2" max="2" step="0.1" value="1" class="slider">

                <!-- Turntable Z-Axis Speed -->
                <div class="frame-control-row" style="margin-top: 12px;">
                    <label for="turntable-speed-z">Z-Axis Speed</label>
                    <span id="turntable-speed-z-value" style="color: var(--text-color-subtle);">0.0</span>
                </div>
                <input type="range" id="turntable-speed-z" min="-2" max="2" step="0.1" value="0" class="slider">
            </div>

            <!-- BACKGROUND SECTION -->
            <div class="controls-section section-with-divider">
                <h4>Background</h4>

                <!-- Background Color -->
                <div class="frame-control-row">
                    <label for="bg-color">Color:</label>
                    <input type="color" id="bg-color" value="#1a1a1a" class="color-picker">
                </div>

                <!-- Transparent Mode -->
                <div style="margin-top: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="bg-transparent" style="cursor: pointer;">
                        <span>Transparent Background</span>
                    </label>
                </div>

                <!-- Background Image Upload -->
                <div class="control-btn" id="bg-image-btn" style="width: 100%; text-align: center; margin-top: 16px; position: relative;">
                    <span id="bg-image-text">Upload Background Image</span>
                    <span class="remove-image" id="bg-image-remove-btn" style="display: none;">&times;</span>
                </div>
                <input type="file" id="bg-image-input" accept="image/*" style="display: none;">

                <!-- Image Fit (hidden until image uploaded) -->
                <div id="bg-fit-group" style="display: none; margin-top: 12px;">
                    <div class="frame-control-row">
                        <label for="bg-fit">Image Fit</label>
                    </div>
                    <select id="bg-fit">
                        <option value="cover">Fill Frame</option>
                        <option value="contain">Fit in Frame</option>
                        <option value="fill">Stretch to Fill</option>
                    </select>
                </div>

                <div style="border-top: 1px solid var(--border-color); margin: 16px 0;"></div>

                <!-- Foreground Image Upload -->
                <div class="control-btn" id="fg-image-btn" style="width: 100%; text-align: center; margin-top: 16px; position: relative;">
                    <span id="fg-image-text">Upload Foreground Image</span>
                    <span class="remove-image" id="fg-image-remove-btn" style="display: none;">&times;</span>
                </div>
                <input type="file" id="fg-image-input" accept="image/png" style="display: none;">
                <div style="font-size: 11px; color: var(--text-color-subtle); margin-top: 4px; text-align: center;">
                    PNG with transparency for graphic posters
                </div>
            </div>

            <!-- EXPORT SECTION -->
            <div class="controls-section">
                <h4>Export</h4>
                <div class="control-btn" id="export-btn" style="width: 100%; text-align: center;">
                    Export Image
                </div>
            </div>

        </div>

        <!-- Canvas Container -->
        <div class="canvas-container">
            <canvas id="three-canvas"></canvas>
            <!-- Foreground canvas for PNG overlays (z-index: 3) -->
            <canvas id="foreground-canvas"></canvas>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Export</h3>
                <button class="modal-close" id="closeExportModal">&times;</button>
            </div>

            <div class="modal-body">
                <div class="modal-section">
                    <label for="exportDuration" class="modal-label">Duration (seconds)</label>
                    <input type="number" id="exportDuration" class="modal-input" min="1" max="60" value="5">
                    <span class="modal-hint">For video and sequence exports</span>
                </div>

                <div class="modal-section">
                    <label for="exportFormat" class="modal-label">Format</label>
                    <select id="exportFormat" class="modal-select">
                        <option value="png">PNG Image</option>
                        <option value="mp4">MP4 Video</option>
                        <option value="png-sequence">PNG Sequence</option>
                        <option value="iframe">iframe Embed Code</option>
                    </select>
                </div>

                <div class="modal-section">
                    <label class="modal-label">Export Size: <span id="exportSizeDisplay">1920 × 1080</span></label>
                    <span class="modal-hint">Exports at canvas size with current view settings</span>
                </div>
            </div>

            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="cancelExport">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="startExport">Start Export</button>
            </div>
        </div>
    </div>

    <!-- Configuration -->
    <script src="js/3d-config.js"></script>

    <!-- Core Viewer Logic -->
    <script src="js/3d-viewer.js"></script>

    <!-- UI Controllers -->
    <script src="js/3d-ui.js"></script>
</body>
</html>
